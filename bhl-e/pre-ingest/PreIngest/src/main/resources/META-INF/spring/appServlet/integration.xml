<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:si="http://www.springframework.org/schema/integration"
	xmlns:stream="http://www.springframework.org/schema/integration/stream"
	xmlns:int-jmx="http://www.springframework.org/schema/integration/jmx"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans 
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/integration/stream 
        http://www.springframework.org/schema/integration/stream/spring-integration-stream-2.0.xsd
        http://www.springframework.org/schema/integration 
        http://www.springframework.org/schema/integration/spring-integration.xsd
        http://www.springframework.org/schema/integration/jmx 
        http://www.springframework.org/schema/integration/jmx/spring-integration-jmx.xsd
        ">

	<int-jmx:mbean-export default-domain="packaging"
		server="mbeanServer" />
	<bean id="mbeanServer" class="org.springframework.jmx.support.MBeanServerFactoryBean">
		<property name="locateExistingServerIfPossible" value="true" />
	</bean>

	<si:message-history />

	<!-- Necessary to use Annotations such as @Publisher, @ServiceActivator -->
	<si:annotation-config default-publisher-channel="default" />
	<si:channel id="default" />

	<si:gateway id="loading"
		service-interface="at.co.ait.domain.integration.ILoadingGateway"
		default-request-channel="loading_ramp" />

	<si:channel id="loading_ramp">
		<si:queue />
		<si:interceptors>
			<si:wire-tap channel="tracking" />
		</si:interceptors>
	</si:channel>

	<bean id="loading_file" class="at.co.ait.domain.services.PreparePackageService" />

	<si:chain input-channel="loading_ramp" output-channel="techmetadata">
		<si:service-activator
			expression="@loading_file.prepare(payload,headers.PREFERENCES)" />
		<si:splitter method="split">
			<bean class="at.co.ait.domain.integration.DigitalObjectSplitter" />
		</si:splitter>
	</si:chain>

	<si:channel id="techmetadata">
		<si:queue />
		<si:interceptors>
			<si:wire-tap channel="tracking" />
		</si:interceptors>
	</si:channel>

	<!-- object tracking (logging) service -->
	<bean id="object_tracking" class="at.co.ait.domain.services.ObjectTrackingService" />
	<si:service-activator input-channel="tracking"
		expression="@object_tracking.log(payload,headers,headers.PREFERENCES.username)" />

	<si:logging-channel-adapter id="si_logger"
		level="INFO" expression="headers" />

	<si:poller id="poller" default="true" fixed-rate="30"
		receive-timeout="30000" />

	<!-- Extract technical metadata from DigitalObject -->
	<bean id="jhove" class="at.co.ait.domain.services.TechMetadataExtractionService" />
	<si:service-activator input-channel="techmetadata"
		output-channel="deep_scan_object" method="enrich" ref="jhove" />

	<!-- Extract DigitalObjectType from DigitalObject -->
	<si:service-activator input-channel="deep_scan_object"
		output-channel="route" method="enrich" ref="tika" />
	<bean id="tika" class="at.co.ait.domain.services.DigitalObjectTypeExtractor" />

	<si:router id="objectrouter" input-channel="route"
		expression="payload.getObjecttypeIdx()">
		<si:mapping value="1" channel="boxing" />
		<si:mapping value="2" channel="converting" />
		<si:mapping value="3" channel="mapping" />
		<si:mapping value="4" channel="pdfbox" />
		<si:mapping value="5" channel="boxing" />
	</si:router>

	<!-- Convert DigitalObject (such as image conversion ) -->
	<si:service-activator input-channel="pdfbox"
		output-channel="taxonfinder" method="extract" ref="pdfbox_service" />
	<bean id="pdfbox_service" class="at.co.ait.domain.services.PDFBoxService" />

	<!-- Convert DigitalObject (such as image conversion ) -->
	<si:service-activator input-channel="converting"
		output-channel="ocr" method="convert" ref="conversion_service" />
	<bean id="conversion_service" class="at.co.ait.domain.services.ConvertImageService" />

	<!-- Convert DigitalObject (such as image conversion ) -->
	<si:service-activator input-channel="ocr"
		output-channel="taxonfinder" expression="@ocr_service.scan(payload,headers.OPTIONS.lang)" />
	<bean id="ocr_service" class="at.co.ait.domain.services.OCRService" />

	<!-- Convert DigitalObject (such as image conversion ) -->
	<si:service-activator input-channel="taxonfinder"
		output-channel="boxing" method="enrich" ref="taxonfinder_service" />
	<bean id="taxonfinder_service" class="at.co.ait.domain.services.TaxonFinderService" />

	<!-- Mapping of metadata using SMT -->
	<si:service-activator input-channel="mapping"
		output-channel="boxing" expression="@mapping_service.map(payload,payload.prefs.smtparams)" />
	<bean id="mapping_service" class="at.co.ait.domain.services.SMTService" />

	<!-- DigitalObjects are boxed together into on package -->
	<bean id="aggregator" class="at.co.ait.domain.services.DeliveryService" />
	<si:aggregator input-channel="boxing" ref="aggregator"
		method="prepareDelivery" output-channel="label_service" />

	<si:service-activator id="label" input-channel="label_service"
		method="enrich" output-channel="deliveries">
		<bean class="at.co.ait.domain.services.LabellingService" />
	</si:service-activator>

	<si:channel id="boxing">
		<si:queue />
		<si:interceptors>
			<si:wire-tap channel="tracking" />
		</si:interceptors>
	</si:channel>

	<bean id="virusscan_service" class="at.co.ait.domain.services.VirusscanService" />
	<si:service-activator input-channel="deliveries"
		output-channel="nfo_rdf" expression="@virusscan_service.scan(payload)">
	</si:service-activator>

	<bean id="aperture_service" class="at.co.ait.domain.services.ApertureService" />
	<si:service-activator input-channel="nfo_rdf"
		output-channel="permid_service" expression="@aperture_service.process(payload)">
	</si:service-activator>

	<bean id="noid_service" class="at.co.ait.domain.services.NoidService" />
	<si:service-activator input-channel="permid_service"
		output-channel="packaging_service" expression="@noid_service.enrich(payload)">
	</si:service-activator>

	<!-- Creation of InformationPackage -->
	<bean id="mets_marshaller" class="at.co.ait.domain.services.MetsMarshallerService" />
	<si:service-activator input-channel="packaging_service"
		output-channel="create_aip" expression="@mets_marshaller.marshal(payload,headers.PREFERENCES)" />

	<!-- Wrap up of packages (copying to archive) -->
	<bean id="wrapup_service" class="at.co.ait.domain.services.WrapUpService" />
	<si:service-activator input-channel="create_aip"
		output-channel="tracking"
		expression="@wrapup_service.wrapup(payload,headers.PREFERENCES.workdirectory)" />

</beans>